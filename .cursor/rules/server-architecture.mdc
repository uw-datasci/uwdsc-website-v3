---
alwaysApply: true
---

# Server Packages & API Architecture

This project follows a **clean architecture pattern** with clear separation between frontend apps and backend services. There is **no Prisma**; data access uses **postgres.js** (via `@uwdsc/db`) and **Supabase** for auth and storage.

## Server Package Structure

The `packages/server/` directory contains three sub-packages:

### ğŸ“¦ `@uwdsc/db` - Database & Supabase

**Purpose**: Database connection, Supabase clients, base repository, migrations

**Location**: `packages/server/db/src/`

**Exports**:
- `@uwdsc/db` (or `@uwdsc/db/connection`, `@uwdsc/db/supabase`) - Postgres `sql` connection, `createSupabaseBrowserClient`, `createSupabaseServerClient`, `createSupabaseMiddlewareClient`
- `@uwdsc/db/baseRepository` - `BaseRepository` (abstract class with protected `sql` for postgres.js)

**Tech**: postgres.js (Supabase Transaction Pooler), Supabase JS/SSR, db-migrate for migrations

### ğŸ“¦ `@uwdsc/core` - Shared Backend Logic

**Purpose**: Shared services and repositories used by web and admin apps

**Location**: `packages/server/core/src/`

**Structure**:
- `services/` - AuthService, ProfileService, ApplicationService, FileService, ResumeService, TeamService
- `repositories/` - ProfileRepository, ApplicationRepository, AuthRepository, etc. (extend `BaseRepository` from `@uwdsc/db`)

**Exports**: Service classes and **singleton instances** `profileService`, `applicationService`, `teamService`. `AuthService` and `ResumeService` take a Supabase client and are created per-request in app `lib/services.ts` via `createAuthService()` / `createResumeService()`.

```typescript
import { profileService, applicationService, teamService } from "@uwdsc/core";
import { AuthService, ResumeService } from "@uwdsc/core";
```

**Dependencies**: `@uwdsc/db`, `@uwdsc/common` (types)

**Tech**: Postgres (postgres.js), Supabase, TypeScript

### ğŸ“¦ `@uwdsc/admin` - Admin App Backend

**Purpose**: Admin-specific services (e.g. profile/member management for admin dashboard)

**Location**: `packages/server/admin/src/`

**Exports**: Admin-specific `profileService` (and related) for member listing/updates

```typescript
import { profileService } from "@uwdsc/admin";
```

**Used by**: `apps/admin` API routes only. **Dependencies**: `@uwdsc/core`, `@uwdsc/db`, `@uwdsc/common`

## API Architecture & Data Flow

### Flow: React Component â†’ lib/api/ â†’ API Route â†’ Service â†’ Repository â†’ Database

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   React Page    â”‚â”€â”€â”€â–¶â”‚ lib/api/ funcs  â”‚â”€â”€â”€â–¶â”‚   app/api/      â”‚
â”‚   (Frontend)    â”‚     â”‚  (Client SDK)   â”‚    â”‚  (API Routes)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    Database     â”‚â—€â”€â”€â”€â”‚   Repository    â”‚â—€â”€â”€â”€â”‚    Service      â”‚
â”‚ (Postgres +     â”‚     â”‚ (extends        â”‚    â”‚ (Business Logic)â”‚
â”‚  Supabase)      â”‚     â”‚ BaseRepository) â”‚    â”‚ @uwdsc/core or  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚ @uwdsc/admin    â”‚
                                               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Layer Breakdown

1. **React Components** (`apps/web/components`, `apps/admin/components`) - Call client API functions from `lib/api/`.

2. **Client API Functions** (`apps/{web,admin}/lib/api/`) - Type-safe wrappers; import types from `@uwdsc/common/types`; call Next.js API routes.

3. **API Routes** (`apps/{web,admin}/app/api/`) - Thin HTTP layer; import services from `@uwdsc/core` or `@uwdsc/admin`; return responses using `ApiResponse` from `@uwdsc/common/utils`.

4. **Services** (`packages/server/core` or `admin`) - Business logic; use **singletons** (`profileService`, `applicationService`, `teamService`) from `@uwdsc/core` where applicable; create **AuthService** / **ResumeService** in app with `createAuthService()` / `createResumeService()` from `lib/services.ts`.

5. **Repositories** (`packages/server/core/src/repositories/`, `admin/...`) - Extend `BaseRepository` from `@uwdsc/db`; use `this.sql` (postgres.js) for queries. No Prisma.

6. **Database** - Postgres (migrations in `packages/server/db`), Supabase for auth and storage.

### Example: Profile API Flow

```typescript
// 1. React component calls API function
import { getProfile } from "@/lib/api";
const profile = await getProfile();

// 2. API function (lib/api/profile.ts) calls fetch("/api/profile")

// 3. API route (app/api/profile/route.ts) calls service
import { profileService } from "@uwdsc/core";
import { ApiResponse } from "@uwdsc/common/utils";
const profile = await profileService.getProfileByUserId(user.id);
return ApiResponse.ok({ profile, isComplete });

// 4. Service uses repository; repository extends BaseRepository from @uwdsc/db
```

### Example: Auth (Supabase required)

```typescript
// API route
import { createAuthService } from "@/lib/services";
const authService = await createAuthService();
const result = await authService.login({ email, password });
```

## Usage Guidelines

### âœ… Do

1. **Import services from `@uwdsc/core` or `@uwdsc/admin`** in API routes; use singletons (`profileService`, `applicationService`, `teamService`) when the service is stateless.
2. **Create AuthService/ResumeService in the app** via `lib/services.ts` using `createSupabaseServerClient` from `@uwdsc/db`.
3. **Extend BaseRepository** from `@uwdsc/db/baseRepository` when creating new repositories.
4. **Use ApiResponse** from `@uwdsc/common/utils` in API routes for consistent responses.
5. **Keep API routes thin** - delegate to services.

### âŒ Don't

1. **Don't import server packages in React components** - use client API functions from `lib/api/`.
2. **Don't put business logic in API routes or repositories** - use services.
3. **Don't access the database directly from API routes** - always go through services and repositories.
4. **Don't assume Prisma** - the project uses postgres.js and Supabase.
