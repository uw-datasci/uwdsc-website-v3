name: CI Quality Gate

on:
  pull_request:
    branches: [main]
    paths-ignore:
      - ".github/**"
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: 24
  PNPM_VERSION: 10.28.2
  INFISICAL_PROJECT_SLUG: uwdsc-54e-y

jobs:
  setup:
    name: Setup & Install Dependencies
    if: ${{ !startsWith(github.head_ref, 'auto-docs/merge-') }}
    runs-on: ubuntu-latest
    outputs:
      node-version: ${{ env.NODE_VERSION }}
      pnpm-version: ${{ env.PNPM_VERSION }}
      infisical-project-slug: ${{ env.INFISICAL_PROJECT_SLUG }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: pnpm
      - run: pnpm install --frozen-lockfile

  code-quality:
    name: Code Quality
    needs: setup
    uses: uw-datasci/nexus-workflows/.github/workflows/quality-gate.yml@v4
    with:
      node-version: ${{ needs.setup.outputs.node-version }}
      pnpm-version: ${{ needs.setup.outputs.pnpm-version }}
      lint-command: pnpm lint
      typecheck-command: pnpm check-types

  build-web:
    name: Build - Web
    needs: [setup, code-quality]
    uses: uw-datasci/nexus-workflows/.github/workflows/build-node.yml@v4
    with:
      node-version: ${{ needs.setup.outputs.node-version }}
      pnpm-version: ${{ needs.setup.outputs.pnpm-version }}
      build-command: pnpm --filter=web... build
      infisical-project-slug: ${{ needs.setup.outputs.infisical-project-slug }}
      infisical-secret-path: /web
    secrets:
      INFISICAL_CLIENT_ID: ${{ secrets.INFISICAL_CLIENT_ID }}
      INFISICAL_CLIENT_SECRET: ${{ secrets.INFISICAL_CLIENT_SECRET }}

  build-cxc:
    name: Build - CxC
    needs: [setup, code-quality]
    uses: uw-datasci/nexus-workflows/.github/workflows/build-node.yml@v4
    with:
      node-version: ${{ needs.setup.outputs.node-version }}
      pnpm-version: ${{ needs.setup.outputs.pnpm-version }}
      build-command: pnpm --filter=cxc... build
      infisical-project-slug: ${{ needs.setup.outputs.infisical-project-slug }}
      infisical-secret-path: /cxc
    secrets:
      INFISICAL_CLIENT_ID: ${{ secrets.INFISICAL_CLIENT_ID }}
      INFISICAL_CLIENT_SECRET: ${{ secrets.INFISICAL_CLIENT_SECRET }}

  quality-summary:
    name: Quality Gate Summary
    runs-on: ubuntu-latest
    needs: [code-quality, build-web, build-cxc]
    if: always()
    permissions:
      pull-requests: write
      contents: read

    steps:
      - name: Post Quality Gate Summary
        uses: uw-datasci/nexus-quality-summary@v1
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          code-quality-result: ${{ needs.code-quality.result }}
          build-result: ${{ needs.build-web.result == 'success' && needs.build-cxc.result == 'success' && 'success' || 'failure' }}
